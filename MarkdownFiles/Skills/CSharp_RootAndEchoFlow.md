# C# RootBot and EchoSkillBot Flow

```mermaid
sequenceDiagram

    participant User
    participant BotController
    participant Root as RootBot Main Logic
    participant SkillHttpClient
    participant ConvoIdFactory as ConversationIdFactory
    participant Activity
    participant AppCredentials
    participant AdalAuthenticator

    participant Echo as EchoSkillBot

    Note left of User: HTTP POST
    Note left of User: Message "skill"
    User ->> BotController: HTTP POST
    activate User
    activate BotController
        BotController ->> Root: OnMessageAsync()
        activate BotController
        activate Root
            Note over Root, SkillHttpClient: Get ActiveSkill from Convo State
            
            Root ->> Root: SendToSkill()
            activate Root
                Note over Root: Save Changes *1
                
                Root ->> SkillHttpClient: PostActivityAsync()
                activate Root
                activate SkillHttpClient
                    SkillHttpClient ->> ConvoIdFactory: CreateSkillConversationIdAsync()
                    activate SkillHttpClient
                    activate ConvoIdFactory
                        ConvoIdFactory ->> Activity: GetConversationReference()
                        activate ConvoIdFactory
                        activate Activity
                            Activity -->> ConvoIdFactory: return Conversation Ref
                        deactivate Activity
                        deactivate ConvoIdFactory

                        Note over ConvoIdFactory, Activity: Serialize Conversation Reference
                        Note over ConvoIdFactory, Activity: Make key (ChannelId:Convo.Id)
                        Note over ConvoIdFactory, Activity: _conversationRefs.GetOrAdd(key, crJson)
                        
                        ConvoIdFactory -->> SkillHttpClient: return key as Skill Convo Id
                    deactivate ConvoIdFactory
                    deactivate SkillHttpClient

                    SkillHttpClient ->> SkillHttpClient: PostActivityAsync()
                    activate SkillHttpClient
                        SkillHttpClient ->> SkillHttpClient: GetAppCredentialsAsync()
                        activate SkillHttpClient
                            Note over SkillHttpClient, ConvoIdFactory: Credentials w/Root's AAD Id as AppId
                            Note over SkillHttpClient, ConvoIdFactory: and Skill's AAD Id as OAuthScope
                            SkillHttpClient -->> SkillHttpClient: return MicrosoftAppCredentials
                        deactivate SkillHttpClient

                        SkillHttpClient ->> AppCredentials: GetTokenAsync()
                        activate SkillHttpClient
                        activate AppCredentials
                            AppCredentials ->> AdalAuthenticator: AcquireTokenAsync()
                            activate AppCredentials
                            activate AdalAuthenticator
                                AdalAuthenticator -->> AppCredentials: return MS Identity AuthenticationResult
                            deactivate AdalAuthenticator
                            deactivate AppCredentials

                            AppCredentials -->> SkillHttpClient: return Token from AuthenticationResult
                        deactivate AppCredentials 
                        deactivate SkillHttpClient

                        activate SkillHttpClient
                            Note over SkillHttpClient, Activity: Capture User-Root Activity Info:
                            Note over SkillHttpClient, Activity: original Conversation.Id, ServiceUrl, & CallerId
                            Note over SkillHttpClient, Activity: Update Activity for Root-Skill conversation *2
                            Note over SkillHttpClient, Activity: Serialize Updated Activity
                            Note over SkillHttpClient, Activity: Build HTTP POST Request *3
                        deactivate SkillHttpClient

                        SkillHttpClient ->> Echo: HTTP POST w/Activity
                        activate SkillHttpClient
                        activate Echo
                            
                        deactivate Echo
                        deactivate SkillHttpClient
                    deactivate SkillHttpClient
                deactivate SkillHttpClient
                deactivate Root
            deactivate Root
        deactivate Root
        deactivate BotController
    deactivate BotController
    deactivate User
```

- *1 Always SaveChanges() before calling a Skill, so that any Activity generated by the Skill will have access to current, accurate state
- *2 See ActivityConversion diagram
- *3 See BuildRequest diagram