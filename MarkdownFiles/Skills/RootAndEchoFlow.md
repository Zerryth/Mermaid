```mermaid
    sequenceDiagram
        participant User
        participant Root as RootBot
        Note left of Root: User Message "skill"
        Note left of Root: Inbound Message
        participant ActiveSkill as ActiveSkillProperty
        Note over ActiveSkill: ConvoState Property Accessor
        participant ConversationState
        participant Memory
        participant TurnContext
        participant SkillClient
        participant ConvoIdFactory as ConversationIdFactory
        participant CredentialProvider
        participant AppCredentials
        participant Echo as EchoSkillBot

        User ->> Root: Message "skill"
        activate User
        Root ->> Root: onMessage()
        activate Root
        Root ->> ActiveSkill: activeSkillProperty.get()
        activate ActiveSkill
        activate Root
        ActiveSkill ->> ConversationState: .load() - Try to get ActiveSkill in state
        activate ConversationState
       
        ConversationState ->> TurnContext: try to .get() cached state
        activate TurnContext
        Note over TurnContext, ActiveSkill: 1st time state is hasn't been cached yet
        TurnContext -->> ConversationState: undefined
        deactivate TurnContext
        
        ConversationState ->> Memory: try to .read() convo state from Memory
        activate Memory
        Memory -->> ConversationState: return empty {}
        deactivate Memory

        ConversationState ->> ConversationState: Create new state object
        ConversationState ->> TurnContext: Sets new state obj into cache in TurnState
        activate TurnContext
        TurnContext -->> ConversationState: 
        deactivate TurnContext
        ConversationState -->> ActiveSkill: return state, which is an empty object {}
        deactivate ConversationState
        Note over Root, ActiveSkill: No ActiveSkill in state, 1st time around
        ActiveSkill -->> Root: return undefined
        deactivate ActiveSkill
        deactivate Root

        Root ->> TurnContext: sendActivity('Got it, connecting you to the skill...')
        activate Root
        activate TurnContext
        TurnContext ->> User: Mesage 'Got it, connecting you to the skill...')
        activate User
        User -->> Root: 200 OK
        deactivate user
        deactivate TurnContext
        deactivate Root

        Root ->> ActiveSkill: .set() EchoSkillBot as the ActiveSkill in cached state
        activate Root
        activate ActiveSkill
        ActiveSkill ->> ConversationState: load() cached state from TurnState
        activate ConversationState
        ConversationState ->> TurnContext: get() cached state
        activate TurnContext
        TurnContext -->> ConversationState: return cached state
        deactivate TurnContext
        ConversationState -->> ActiveSkill: return cached state
        deactivate ConversationState
        ActiveSkill ->> ActiveSkill: set EchoSkillBot as the ActiveSkill in cached state
        ActiveSkill -->> Root: 
        deactivate ActiveSkill
        deactivate Root

        Note over Root: Send the Activity to the Skill
        Root ->> Root: sendToSkill()
        activate Root
        Note over Root, ConversationState: Always save changes before calling a Skill, so that any Activity
        Note over Root, ConversationState: generated by the Skill will have access to current accurate state
        Root ->> ConversationState: saveChanges()
        activate ConversationState
        ConversationState ->> TurnContext: get() cached state
        activate TurnContext
        TurnContext -->> ConversationState: return cached state
        deactivate TurnContext
        ConversationState ->> Memory: write() changes to storage layer
        activate Memory
        Memory -->> ConversationState: 
        deactivate Memory
        ConversationState ->> TurnContext: Update changes in cache
        activate TurnContext
        TurnContext -->> ConversationState:  
        deactivate TurnContext
        ConversationState -->> Root: 
        deactivate ConversationState
        deactivate Root

        Note over ConversationState, Memory: Route the Activity to the Skill
        Root ->> SkillClient: postToSkill()
        activate Root
        activate SkillClient

        SkillClient ->> TurnContext: getConversationReference()
        activate SkillClient
        activate TurnContext
        TurnContext -->> SkillClient: return conversation reference
        deactivate TurnContext
        deactivate SkillClient

        SkillClient ->> ConvoIdFactory: createSkillConversationId()
        activate SkillClient
        activate ConvoIdFactory
        Note over ConvoIdFactory, Echo: Store original (user-root) conversation reference
        ConvoIdFactory -->> SkillClient: return Skill ConversationId
        deactivate SkillClient
        deactivate ConvoIdFactory
        Note over SkillClient, Echo: Ex.: "emulator:008fe321-37cb-11ea-9677-a18315f80013|livechat"

        SkillClient ->> SkillClient: postActivity()
        activate SkillClient
            SkillClient ->> SkillClient: getAppCredentials()
            activate SkillClient
            Note over SkillClient, ConvoIdFactory: 1st time calling to Skill, therefore
            Note over SkillClient, ConvoIdFactory: AppCredentials aren't in cache yet
            SkillClient ->> CredentialProvider: getAppPassword()
            activate SkillClient
            activate CredentialProvider
            CredentialProvider -->> SkillClient: return appPassword if has valid appId
            deactivate SkillClient
            deactivate CredentialProvider
            SkillClient ->> AppCredentials: new MicrosoftAppCredentials()
            activate AppCredentials
            Note over TurnContext, ConvoIdFactory: Cache Credentials in SkillClient for later use
            AppCredentials -->> SkillClient: return credentials
            deactivate AppCredentials
            deactivate SkillClient
            
            SkillClient ->> AppCredentials : getToken()
            activate SkillClient
            activate AppCredentials
            alt no force refresh
                AppCredentials ->> AppCredentials: using token cache key, try to get token from credential's cache
                AppCredentials -->> SkillClient: return if cached Token

                else force refresh/expired token/no cached token
                    AppCredentials ->> AppCredentials: refreshToken()
                    Note over CredentialProvider, Echo: Use credential's Auth context to acquire token with client credentials
                    Note over CredentialProvider, Echo: Cache new Token in credential's token cache
                    AppCredentials -->> SkillClient: return Token
            end
            deactivate AppCredentials
            deactivate SkillClient

            Note over TurnContext, CredentialProvider: Save current Activity settings before changing them, including: conversation Id, serviceUrl, callerId
            Note over TurnContext, CredentialProvider: Replace User-Root Activity values with Root-Skill Activity values 
            Note over TurnContext, CredentialProvider: conversation Id = Skill's convo Id, serviceUrl = Skill Host Endpoint, callerId = Root's appId 
            Note over TurnContext, CredentialProvider: Set request Headers, including adding Token to Authorization header
            
            SkillClient ->> Echo: axios.post()
            activate SkillClient
            activate Echo



        deactivate AppCredentials
        deactivate SkillClient
        activate AppCredentials

        deactivate Root
        deactivate User

```